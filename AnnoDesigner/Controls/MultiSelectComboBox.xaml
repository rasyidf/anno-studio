<UserControl x:Class="AnnoDesigner.Controls.MultiSelectComboBox"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AnnoDesigner.Controls" xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             mc:Ignorable="d" 
             d:DesignHeight="62.667" d:DesignWidth="800" x:Name="ThisUserControl"
              >
    <Grid>
        <ComboBox 
            ItemsSource="{Binding ItemsSource, ElementName=ThisUserControl}"
            Text="{Binding Text, ElementName=ThisUserControl, Mode=OneWay}"
            IsEditable="True"
            IsReadOnly="True"
             
            Background="Transparent"
            BorderThickness="0">

        <ComboBox.ItemTemplate>
            <DataTemplate  >
                <StackPanel Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding IsSelected}" Content="{Binding Name}" Focusable="False" Margin="3,0"/>
                </StackPanel>
            </DataTemplate>
        </ComboBox.ItemTemplate>

        <ComboBox.Template>
            <ControlTemplate TargetType="{x:Type ComboBox}">

                <Grid SnapsToDevicePixels="True">

                    <ToggleButton x:Name="toggleButton"
                                      IsChecked="{Binding IsDropDownOpen, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
                                      Focusable="False"
                                      Background="Transparent" 
                                      BorderThickness="0"
                                      Width="0" Height="0" Opacity="0"
                                      HorizontalAlignment="Right" VerticalAlignment="Center" />

                    <Border x:Name="BackgroundBorder"
                                Background="Transparent" 
                                BorderBrush="Transparent" 
                                BorderThickness="0">

                        <TextBox x:Name="PART_EditableTextBox"
                                     IsReadOnly="True"
                                     Focusable="False"
                                     Text="{Binding Text, ElementName=ThisUserControl, Mode=OneWay}"
                                     Padding="{TemplateBinding Padding}"
                                     VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                     HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                     Background="Transparent"
                                     BorderThickness="0"
                                     Cursor="Arrow"
                                     />
                    </Border>

                    <Popup x:Name="PART_Popup"
                               AllowsTransparency="true"
                               IsOpen="{TemplateBinding IsDropDownOpen}"
                               Placement="Bottom">
                        <Border x:Name="DropDownBorder"
                                    BorderThickness="1"
                                    Background="{DynamicResource {x:Static SystemColors.WindowBrushKey}}"
                                    BorderBrush="{DynamicResource {x:Static SystemColors.ActiveBorderBrushKey}}">
                            <ScrollViewer>
                                <ItemsPresenter />
                            </ScrollViewer>
                        </Border>
                    </Popup>

                </Grid>

                <ControlTemplate.Triggers>
                    <Trigger Property="IsFocused" Value="True">
                        <Setter TargetName="toggleButton" Property="IsChecked" Value="True"/>
                    </Trigger>
                </ControlTemplate.Triggers>
            </ControlTemplate>
        </ComboBox.Template>

        </ComboBox>
    </Grid>
</UserControl>