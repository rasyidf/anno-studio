<UserControl
    x:Class="AnnoDesigner.Views.PropertiesPanel"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:AnnoDesigner.Converters"
    xmlns:cp="clr-namespace:ColorPicker;assembly=ColorPicker"
    xmlns:l="clr-namespace:AnnoDesigner.Localization"
    xmlns:local="clr-namespace:AnnoDesigner.Controls"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit">

    <DockPanel Name="rootPanel" Margin="2" LastChildFill="True">

        <!-- Header / Layout settings -->
        <GroupBox DockPanel.Dock="Top" Margin="0,0,0,6">
            <Grid Margin="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Grid.Column="0" FontWeight="Bold" VerticalAlignment="Center" Text="{l:Localize LayoutSettings}"/>
                <TextBlock Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize Version}"/>

                <TextBox Grid.Row="0" Grid.Column="1" Width="120" HorizontalAlignment="Right" Text="{Binding LayoutSettingsViewModel.LayoutVersionDisplayValue}" Margin="0,0,0,4"/>
                <TextBlock Grid.Row="1" Grid.Column="1" HorizontalAlignment="Right" Text=""/>
            </Grid>
        </GroupBox>

        <!-- Compact property grid -->
        <GroupBox DockPanel.Dock="Top">
            <ScrollViewer Padding="2" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                <Grid Margin="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Rows: each row is one property. Use compact vertical spacing via Margin on controls. -->
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Section title -->
                    <TextBlock Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" FontSize="14" FontWeight="SemiBold" Text="{l:Localize BuildingSettings}" Margin="0,0,0,6"/>

                    <!-- Size -->
                    <TextBlock Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize Size}"/>
                    <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,2,0,2">
                        <ui:NumberBox Width="100" Minimum="1" Value="{Binding BuildingSettingsViewModel.BuildingWidth, FallbackValue=4}" SpinButtonPlacementMode="Compact"/>
                        <TextBlock VerticalAlignment="Center" Margin="6,0">x</TextBlock>
                        <ui:NumberBox Width="100" Minimum="1" Value="{Binding BuildingSettingsViewModel.BuildingHeight, FallbackValue=4, TargetNullValue=4}" SpinButtonPlacementMode="Compact"/>
                    </StackPanel>

                    <!-- Color -->
                    <TextBlock Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize Color}"/>
                    <StackPanel Grid.Row="2" Grid.Column="1" HorizontalAlignment="Right" Margin="0,2,0,2">
                        <ui:Card Padding="2" HorizontalAlignment="Right">
                            <cp:PortableColorPicker x:Name="colorPicker" Width="100" Height="28" SelectedColor="{Binding BuildingSettingsViewModel.SelectedColor, Mode=TwoWay}" ShowAlpha="False" Style="{StaticResource DefaultColorPickerStyle}" UseHintColor="True"/>
                        </ui:Card>
                    </StackPanel>

                    <!-- Color actions -->
                    <TextBlock Grid.Row="3" Grid.Column="0"/>
                    <StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,2,0,2">
                        <ui:SplitButton Command="{Binding BuildingSettingsViewModel.ApplyColorToSelectionCommand}" ToolTip="{l:Localize ApplyColorToSelectionToolTip}">
                            <ui:SplitButton.Flyout>
                                <Button Command="{Binding BuildingSettingsViewModel.ApplyPredefinedColorToSelectionCommand}" Content="{l:Localize ApplyPredefinedColorToSelection}"/>
                            </ui:SplitButton.Flyout>
                        </ui:SplitButton>
                    </StackPanel>

                    <!-- Colors in layout expander -->
                    <TextBlock Grid.Row="4" Grid.Column="0"/>
                    <Expander Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2" Header="{l:Localize ColorsInLayout}" IsExpanded="False" MaxHeight="90" ToolTip="{l:Localize ColorsInLayoutToolTip}" Visibility="{Binding BuildingSettingsViewModel.ShowColorsInLayout, Converter={StaticResource ConverterBoolToVisibility}}">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding BuildingSettingsViewModel.ColorsInLayout}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="2">
                                            <Rectangle Margin="2" Fill="{Binding MediaColor, Converter={StaticResource ConverterColorToSolidColorBrush}}" Stroke="#FFABADB3" StrokeThickness="1" ToolTip="{Binding}">
                                                <Rectangle.InputBindings>
                                                    <MouseBinding Command="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ItemsControl}}, Path=DataContext.BuildingSettingsViewModel.UseColorInLayoutCommand}" CommandParameter="{Binding}" Gesture="LeftDoubleClick"/>
                                                </Rectangle.InputBindings>
                                            </Rectangle>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel HorizontalAlignment="Right" ItemHeight="20" ItemWidth="20"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </ScrollViewer>
                    </Expander>

                    <!-- Label -->
                    <TextBlock Grid.Row="5" Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize Label}"/>
                    <StackPanel Grid.Row="5" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,2,0,2">
                        <TextBox Width="180" Text="{Binding BuildingSettingsViewModel.BuildingName}"/>
                    </StackPanel>

                    <!-- Icon -->
                    <TextBlock Grid.Row="6" Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize Icon}"/>
                    <ComboBox x:Name="comboBoxIcon" Grid.Row="6" Grid.Column="1" Width="220" HorizontalAlignment="Right" ItemsSource="{Binding AvailableIcons}" SelectedItem="{Binding SelectedIcon}" TextSearch.TextPath="DisplayName">
                        <ComboBox.Resources>
                            <Style TargetType="{x:Type Popup}"><Setter Property="Width" Value="300"/></Style>
                            <converters:IconImageToDisplayNameConverter x:Key="converterIconImageToDisplayName"/>
                        </ComboBox.Resources>
                        <ComboBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling"/>
                            </ItemsPanelTemplate>
                        </ComboBox.ItemsPanel>
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Margin="4"><Image Width="20" Source="{Binding Icon}"/></Viewbox>
                                    <TextBlock VerticalAlignment="Center" Margin="4,0,4,0" Text="{Binding ., Converter={StaticResource converterIconImageToDisplayName}}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <!-- Influence type -->
                    <TextBlock Grid.Row="7" Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize InfluenceType}"/>
                    <ComboBox Grid.Row="7" Grid.Column="1" Width="140" HorizontalAlignment="Right" DisplayMemberPath="Name" ItemsSource="{Binding BuildingSettingsViewModel.BuildingInfluences}" SelectedItem="{Binding BuildingSettingsViewModel.SelectedBuildingInfluence}"/>

                    <!-- Radius -->
                    <TextBlock Grid.Row="8" Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize Radius}" Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRadiusVisible, Converter={StaticResource ConverterBoolToVisibilityCollapsed}}"/>
                    <ui:NumberBox Grid.Row="8" Grid.Column="1" Width="120" HorizontalAlignment="Right" Minimum="0" Value="{Binding BuildingSettingsViewModel.BuildingRadius, FallbackValue=0}" Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRadiusVisible, Converter={StaticResource ConverterBoolToVisibilityCollapsed}}" SpinButtonPlacementMode="Compact"/>

                    <!-- Distance -->
                    <TextBlock Grid.Row="9" Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize Distance}" Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRangeVisible, Converter={StaticResource ConverterBoolToVisibilityCollapsed}}"/>
                    <ui:NumberBox Grid.Row="9" Grid.Column="1" Width="120" HorizontalAlignment="Right" LargeChange="0.1" MaxDecimalPlaces="2" Value="{Binding BuildingSettingsViewModel.BuildingInfluenceRange, FallbackValue=0}" Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRangeVisible, Converter={StaticResource ConverterBoolToVisibilityCollapsed}}" SpinButtonPlacementMode="Compact"/>

                    <!-- Paved street -->
                    <TextBlock Grid.Row="10" Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize PavedStreet}" Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRangeVisible, Converter={StaticResource ConverterBoolToVisibilityCollapsed}}"/>
                    <ui:ToggleSwitch Grid.Row="10" Grid.Column="1" HorizontalAlignment="Right" IsChecked="{Binding BuildingSettingsViewModel.IsPavedStreet}" OffContent="{l:Localize Off}" OnContent="{l:Localize On}" Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRangeVisible, Converter={StaticResource ConverterBoolToVisibilityCollapsed}}"/>

                    <!-- Options expander -->
                    <ui:CardExpander Grid.Row="11" Grid.Column="0" Grid.ColumnSpan="2" Header="{l:Localize Options}" IsExpanded="True" Margin="0,6,0,0">
                        <StackPanel Orientation="Vertical">
                            <Grid Margin="0,0,0,4">
                                <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize EnableLabel}"/>
                                <ui:ToggleSwitch Grid.Column="1" HorizontalAlignment="Right" IsChecked="{Binding BuildingSettingsViewModel.IsEnableLabelChecked}" OffContent="{l:Localize Off}" OnContent="{l:Localize On}"/>
                            </Grid>

                            <Grid Margin="0,0,0,4">
                                <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize Borderless}"/>
                                <ui:ToggleSwitch Grid.Column="1" HorizontalAlignment="Right" IsChecked="{Binding BuildingSettingsViewModel.IsBorderlessChecked}" OffContent="{l:Localize Off}" OnContent="{l:Localize On}"/>
                            </Grid>

                            <Grid>
                                <Grid.ColumnDefinitions><ColumnDefinition Width="*"/><ColumnDefinition Width="Auto"/></Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" VerticalAlignment="Center" Text="{l:Localize Road}"/>
                                <ui:ToggleSwitch Grid.Column="1" HorizontalAlignment="Right" IsChecked="{Binding BuildingSettingsViewModel.IsRoadChecked}" OffContent="{l:Localize Off}" OnContent="{l:Localize On}"/>
                            </Grid>
                        </StackPanel>
                    </ui:CardExpander>

                </Grid>
            </ScrollViewer>
        </GroupBox>

        <!-- Place button -->
        <Button DockPanel.Dock="Bottom" HorizontalAlignment="Right" Margin="0,6,0,0" Command="{Binding PlaceBuildingCommand}" Content="{l:Localize PlaceBuilding}"/>

    </DockPanel>
</UserControl>