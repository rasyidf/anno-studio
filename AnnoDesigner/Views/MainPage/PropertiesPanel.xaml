<UserControl
    x:Class="AnnoDesigner.Views.PropertiesPanel"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:AnnoDesigner.Converters"
    xmlns:cp="clr-namespace:ColorPicker;assembly=ColorPicker"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:l="clr-namespace:AnnoDesigner.Localization"
    xmlns:local="clr-namespace:AnnoDesigner.Controls"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
    d:DesignWidth="490"
    mc:Ignorable="d">

    <UserControl.Resources>
        <Style x:Key="PropertyLabel" TargetType="{x:Type TextBlock}">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Margin" Value="0,0,6,0" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>
        <Style x:Key="CompactStack" TargetType="{x:Type StackPanel}">
            <Setter Property="Orientation" Value="Horizontal" />
            <Setter Property="Margin" Value="0,1,0,1" />
        </Style>
    </UserControl.Resources>

    <DockPanel
        x:Name="rootPanel"
        Margin="2"
        LastChildFill="True">

        <!--  Selection summary (compact header like Figma)  -->
        <StackPanel Margin="4,0,4,6" DockPanel.Dock="Top">
            <TextBlock
                FontSize="14"
                FontWeight="Bold"
                Text="{Binding SelectionSummary}" />
            <TextBlock
                FontSize="11"
                Foreground="#FF6B6B6B"
                Text="{Binding SelectionSubtitle}" />
            <Separator Margin="0,6,0,6" />
        </StackPanel>

        <!--  Hidden accessible color picker instance for code-behind and programmatic access  -->
        <cp:PortableColorPicker
            x:Name="colorPicker"
            SelectedColor="{Binding BuildingSettingsViewModel.SelectedColor, Mode=TwoWay}"
            ShowAlpha="False"
            Visibility="Collapsed" />
        <!--  Header / Layout settings  -->
        <GroupBox Margin="0,0,0,6" DockPanel.Dock="Top">
            <Grid Margin="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock
                    Grid.Row="0"
                    Grid.Column="0"
                    VerticalAlignment="Center"
                    FontWeight="Bold"
                    Style="{StaticResource PropertyLabel}"
                    Text="{l:Localize LayoutSettings}" />
                <TextBlock
                    Grid.Row="1"
                    Grid.Column="0"
                    VerticalAlignment="Center"
                    Style="{StaticResource PropertyLabel}"
                    Text="{l:Localize Version}" />

                <TextBox
                    Grid.Row="1"
                    Grid.Column="1"
                    Width="120"
                    Margin="0,0,0,4"
                    HorizontalAlignment="Right"
                    Text="{Binding LayoutSettingsViewModel.LayoutVersionDisplayValue}" />
                <TextBlock
                    Grid.Row="1"
                    Grid.Column="1"
                    HorizontalAlignment="Right"
                    Text="" />
            </Grid>
        </GroupBox>

        <ui:CardExpander
            Margin="0,6,0,0"
            Padding="8"
            DockPanel.Dock="Top"
            Header="{l:Localize BuildingSettings}"
            IsExpanded="True">
            <StackPanel Orientation="Vertical">
                <!--  Size  -->
                <local:PropertyGridItem
                    Grid.Row="1"
                    Grid.Column="0"
                    Grid.ColumnSpan="2"
                    Header="{l:Localize Size}">
                    <local:PropertyGridItem.ValueTemplate>
                        <DataTemplate>
                            <StackPanel HorizontalAlignment="Right" Orientation="Horizontal">
                                <ui:NumberBox
                                    Width="100"
                                    Minimum="1"
                                    SpinButtonPlacementMode="Compact"
                                    Value="{Binding BuildingSettingsViewModel.BuildingWidth}" />
                                <TextBlock Margin="6,0" VerticalAlignment="Center"><Run Text="x" /></TextBlock>
                                <ui:NumberBox
                                    Width="100"
                                    Minimum="1"
                                    SpinButtonPlacementMode="Compact"
                                    Value="{Binding BuildingSettingsViewModel.BuildingHeight}" />
                            </StackPanel>
                        </DataTemplate>
                    </local:PropertyGridItem.ValueTemplate>
                </local:PropertyGridItem>

                <!--  Color  -->
                <local:PropertyGridItem
                    Grid.Row="2"
                    Grid.Column="0"
                    Grid.ColumnSpan="2"
                    Header="{l:Localize Color}">
                    <local:PropertyGridItem.ValueTemplate>
                        <DataTemplate>
                            <ui:Card Padding="4" HorizontalAlignment="Right">
                                <cp:PortableColorPicker
                                    Width="100"
                                    Height="28"
                                    HexRepresentation="ARGB"
                                    SelectedColor="{Binding BuildingSettingsViewModel.SelectedColor, Mode=TwoWay}"
                                    ShowAlpha="False"
                                    Style="{StaticResource DefaultColorPickerStyle}"
                                    UseHintColor="True" />
                            </ui:Card>
                        </DataTemplate>
                    </local:PropertyGridItem.ValueTemplate>
                </local:PropertyGridItem>

                <!--  Color actions  -->
                <TextBlock Grid.Row="3" Grid.Column="0" />
                <StackPanel
                    Grid.Row="3"
                    Grid.Column="1"
                    Margin="0,1,0,1"
                    HorizontalAlignment="Right"
                    Orientation="Horizontal">
                    <ui:SplitButton
                        Height="32"
                        Command="{Binding BuildingSettingsViewModel.ApplyColorToSelectionCommand}"
                        Icon="{ui:SymbolIcon Symbol=PaintBrush24}"
                        ToolTip="{l:Localize ApplyColorToSelectionToolTip}">
                        <ui:SplitButton.Flyout>
                            <ContextMenu>
                                <MenuItem Command="{Binding BuildingSettingsViewModel.ApplyPredefinedColorToSelectionCommand}" Header="{l:Localize ApplyPredefinedColorToSelection}" />
                            </ContextMenu>
                        </ui:SplitButton.Flyout>
                    </ui:SplitButton>
                </StackPanel>

                <!--  Colors in layout expander  -->
                <TextBlock Grid.Row="4" Grid.Column="0" />
                <Expander
                    Grid.Row="4"
                    Grid.Column="0"
                    Grid.ColumnSpan="2"
                    MaxHeight="90"
                    Header="{l:Localize ColorsInLayout}"
                    IsExpanded="False"
                    ToolTip="{l:Localize ColorsInLayoutToolTip}"
                    Visibility="{Binding BuildingSettingsViewModel.ShowColorsInLayout, Converter={StaticResource ConverterBoolToVisibility}}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding BuildingSettingsViewModel.ColorsInLayout}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border CornerRadius="2">
                                        <Rectangle
                                            Margin="2"
                                            Fill="{Binding MediaColor, Converter={StaticResource ConverterColorToSolidColorBrush}}"
                                            Stroke="#FFABADB3"
                                            StrokeThickness="1"
                                            ToolTip="{Binding}">
                                            <Rectangle.InputBindings>
                                                <MouseBinding
                                                    Command="{Binding DataContext.BuildingSettingsViewModel.UseColorInLayoutCommand, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}, Mode=FindAncestor}}"
                                                    CommandParameter="{Binding}"
                                                    Gesture="LeftDoubleClick" />
                                            </Rectangle.InputBindings>
                                        </Rectangle>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel
                                        HorizontalAlignment="Right"
                                        ItemHeight="20"
                                        ItemWidth="20" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </ScrollViewer>
                </Expander>

                <!--  Label  -->
                <local:PropertyGridItem
                    Grid.Row="5"
                    Grid.Column="0"
                    Grid.ColumnSpan="2"
                    Header="{l:Localize Label}">
                    <local:PropertyGridItem.ValueTemplate>
                        <DataTemplate>
                            <TextBox
                                Width="200"
                                HorizontalAlignment="Right"
                                Text="{Binding BuildingSettingsViewModel.BuildingName}" />
                        </DataTemplate>
                    </local:PropertyGridItem.ValueTemplate>
                </local:PropertyGridItem>

                <!--  Icon  -->
                <local:PropertyGridItem
                    x:Name="comboBoxIcon"
                    Grid.Row="6"
                    Grid.Column="0"
                    Grid.ColumnSpan="2"
                    Header="{l:Localize Icon}">
                    <local:PropertyGridItem.ValueTemplate>
                        <DataTemplate>
                            <ComboBox
                                Width="200"
                                HorizontalAlignment="Right"
                                ItemsSource="{Binding AvailableIcons}"
                                SelectedItem="{Binding SelectedIcon}"
                                TextSearch.TextPath="DisplayName">
                                <ComboBox.Resources>
                                    <Style TargetType="{x:Type Popup}">
                                        <Setter Property="Width" Value="300" />
                                    </Style>
                                    <converters:IconImageToDisplayNameConverter x:Key="converterIconImageToDisplayName" />
                                </ComboBox.Resources>
                                <ComboBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <VirtualizingStackPanel VirtualizingPanel.IsVirtualizing="True" VirtualizingPanel.VirtualizationMode="Recycling" />
                                    </ItemsPanelTemplate>
                                </ComboBox.ItemsPanel>
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Viewbox Margin="4">
                                                <Image Width="20" Source="{Binding Icon}" />
                                            </Viewbox>
                                            <TextBlock
                                                Margin="4,0,4,0"
                                                VerticalAlignment="Center"
                                                Text="{Binding ., Converter={StaticResource converterIconImageToDisplayName}}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </DataTemplate>
                    </local:PropertyGridItem.ValueTemplate>
                </local:PropertyGridItem>

                <!--  Influence type  -->
                <local:PropertyGridItem Grid.Row="7" Header="{l:Localize InfluenceType}">
                    <local:PropertyGridItem.ValueTemplate>
                        <DataTemplate>
                            <ComboBox
                                Width="200"
                                HorizontalAlignment="Right"
                                DisplayMemberPath="Name"
                                ItemsSource="{Binding BuildingSettingsViewModel.BuildingInfluences}"
                                SelectedItem="{Binding BuildingSettingsViewModel.SelectedBuildingInfluence}" />
                        </DataTemplate>
                    </local:PropertyGridItem.ValueTemplate>
                </local:PropertyGridItem>

                <!--  Radius  -->
                <local:PropertyGridItem
                    Grid.Row="8"
                    Header="{l:Localize Radius}"
                    Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRadiusVisible, Converter={StaticResource ConverterBoolToVisibilityCollapsed}}">
                    <local:PropertyGridItem.ValueTemplate>
                        <DataTemplate>
                            <ui:NumberBox
                                Width="200"
                                HorizontalAlignment="Left"
                                Minimum="0"
                                SpinButtonPlacementMode="Compact"
                                Value="{Binding BuildingSettingsViewModel.BuildingRadius, FallbackValue=0}" />
                        </DataTemplate>
                    </local:PropertyGridItem.ValueTemplate>
                </local:PropertyGridItem>

                <!--  Distance  -->
                <local:PropertyGridItem
                    Grid.Row="9"
                    Header="{l:Localize Distance}"
                    Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRangeVisible, Converter={StaticResource ConverterBoolToVisibilityCollapsed}}">
                    <local:PropertyGridItem.ValueTemplate>
                        <DataTemplate>
                            <ui:NumberBox
                                Width="200"
                                HorizontalAlignment="Left"
                                LargeChange="0.1"
                                MaxDecimalPlaces="2"
                                SpinButtonPlacementMode="Compact"
                                Value="{Binding BuildingSettingsViewModel.BuildingInfluenceRange, FallbackValue=0}" />
                        </DataTemplate>
                    </local:PropertyGridItem.ValueTemplate>
                </local:PropertyGridItem>

                <!--  Paved street  -->
                <local:PropertyGridItem
                    Grid.Row="10"
                    Header="{l:Localize PavedStreet}"
                    Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRangeVisible, Converter={StaticResource ConverterBoolToVisibilityCollapsed}}">
                    <local:PropertyGridItem.ValueTemplate>
                        <DataTemplate>
                            <ui:ToggleSwitch
                                HorizontalAlignment="Right"
                                IsChecked="{Binding BuildingSettingsViewModel.IsPavedStreet}"
                                OffContent="{l:Localize Off}"
                                OnContent="{l:Localize On}" />
                        </DataTemplate>
                    </local:PropertyGridItem.ValueTemplate>
                </local:PropertyGridItem>

                <!--  Options expander  -->
                <ui:CardExpander
                    Grid.Row="11"
                    Grid.Column="0"
                    Grid.ColumnSpan="2"
                    Margin="0,6,0,0"
                    Padding="8"
                    Header="{l:Localize Options}"
                    IsExpanded="True">
                    <StackPanel Orientation="Vertical">
                        <local:PropertyGridItem Header="{l:Localize EnableLabel}">
                            <local:PropertyGridItem.ValueTemplate>
                                <DataTemplate>
                                    <ui:ToggleSwitch
                                        HorizontalAlignment="Right"
                                        IsChecked="{Binding BuildingSettingsViewModel.IsEnableLabelChecked}"
                                        OffContent="{l:Localize Off}"
                                        OnContent="{l:Localize On}" />
                                </DataTemplate>
                            </local:PropertyGridItem.ValueTemplate>
                        </local:PropertyGridItem>

                        <local:PropertyGridItem Header="{l:Localize Borderless}">
                            <local:PropertyGridItem.ValueTemplate>
                                <DataTemplate>
                                    <ui:ToggleSwitch
                                        HorizontalAlignment="Right"
                                        IsChecked="{Binding BuildingSettingsViewModel.IsBorderlessChecked}"
                                        OffContent="{l:Localize Off}"
                                        OnContent="{l:Localize On}" />
                                </DataTemplate>
                            </local:PropertyGridItem.ValueTemplate>
                        </local:PropertyGridItem>

                        <local:PropertyGridItem Header="{l:Localize Road}">
                            <local:PropertyGridItem.ValueTemplate>
                                <DataTemplate>
                                    <ui:ToggleSwitch
                                        HorizontalAlignment="Right"
                                        IsChecked="{Binding BuildingSettingsViewModel.IsRoadChecked}"
                                        OffContent="{l:Localize Off}"
                                        OnContent="{l:Localize On}" />
                                </DataTemplate>
                            </local:PropertyGridItem.ValueTemplate>
                        </local:PropertyGridItem>
                    </StackPanel>
                </ui:CardExpander>


            </StackPanel>

        </ui:CardExpander>
        <!--  Compact property grid  -->

        <!--  Place button  -->
        <Button
            Margin="0,6,0,0"
            HorizontalAlignment="Right"
            Command="{Binding PlaceBuildingCommand}"
            Content="{l:Localize PlaceBuilding}"
            DockPanel.Dock="Bottom" />

    </DockPanel>
</UserControl>