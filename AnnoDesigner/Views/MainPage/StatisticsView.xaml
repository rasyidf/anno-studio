<UserControl
    x:Class="AnnoDesigner.StatisticsView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converter="clr-namespace:AnnoDesigner.Core.Converters;assembly=AnnoDesigner.Core"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:l="clr-namespace:AnnoDesigner.Localization"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:viewModel="clr-namespace:AnnoDesigner.ViewModels"
    d:Background="White"
    d:Foreground="Black"
    d:DataContext="{d:DesignInstance Type=viewModel:StatisticsViewModel,
                                     IsDesignTimeCreatable=False}"
    d:DesignHeight="350"
    d:DesignWidth="250"
    mc:Ignorable="d">

    <UserControl.Resources>
        <ResourceDictionary>

            <converter:BoolToVisibilityConverter
                x:Key="boolToVisConverter"
                FalseValue="Collapsed"
                TrueValue="Visible" />
            <converter:BoolToVisibilityConverter
                x:Key="invertedBoolToVisConverter"
                FalseValue="Visible"
                TrueValue="Collapsed" />

            <!--  Use theme-aware brushes from ui library when available  -->
            <SolidColorBrush x:Key="CardBackgroundBrush" Color="Transparent" />
            <!-- Prefer theme-provided dynamic resources instead of fixed colors -->

        </ResourceDictionary>
    </UserControl.Resources>

    <!--  Disable horizontal scrolling so WrapPanel can wrap to the available width; allow vertical scroll only  -->
    <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
        <!--  Use Grid so children get proper width constraints  -->
        <Grid Margin="6">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <TextBlock
                x:Name="tblNothingPlaced"
                Grid.Row="0"
                Margin="5"
                HorizontalAlignment="Center"
                FontStyle="Italic"
                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                Text="{l:Localize StatNothingPlaced}"
                Visibility="{Binding AreStatisticsAvailable, Converter={StaticResource invertedBoolToVisConverter}}" />

            <WrapPanel
                Grid.Row="1"
                Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Grid}}"
                HorizontalAlignment="Left"
                Orientation="Horizontal"
                Visibility="{Binding AreStatisticsAvailable, Converter={StaticResource boolToVisConverter}}">

                <!--  Bounding box card  -->
                <ui:Card Style="{StaticResource CompactCardStyle}">
                    <StackPanel>
                        <TextBlock Style="{StaticResource CompactHeader}" Text="{l:Localize StatBoundingBox}" />
                        <TextBlock Style="{StaticResource CompactValue}" Text="{Binding UsedArea}" />
                        <TextBlock Style="{StaticResource CompactLabel}">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} {1}">
                                    <Binding Path="UsedTiles" />
                                    <l:Localize Key="StatTiles" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </ui:Card>

                <!--  Minimum area card  -->
                <ui:Card Style="{StaticResource CompactCardStyle}">
                    <StackPanel>
                        <TextBlock Style="{StaticResource CompactHeader}" Text="{l:Localize StatMinimumArea}" />
                        <TextBlock Style="{StaticResource CompactValue}">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0} {1}">
                                    <Binding Path="MinTiles" />
                                    <l:Localize Key="StatTiles" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </StackPanel>
                </ui:Card>

                <!--  Efficiency card with subtle progress bar  -->
                <ui:Card Style="{StaticResource CompactCardStyle}">
                    <StackPanel>
                        <TextBlock Style="{StaticResource CompactHeader}" Text="{l:Localize StatSpaceEfficiency}" />
                        <TextBlock Style="{StaticResource CompactValue}" Text="{Binding Efficiency}" />
                        <ProgressBar
                            Height="8"
                            Background="{DynamicResource {x:Static SystemColors.AccentColorBrushKey}}"
                            Foreground="{DynamicResource {x:Static SystemColors.AccentColorBrushKey}}"
                            Maximum="100"
                            Minimum="0"
                            Value="{Binding EfficiencyPercent}" />
                    </StackPanel>
                </ui:Card>

                <!--  Buildings list card  -->
                <ui:Card Style="{StaticResource CompactCardLargeStyle}" Visibility="{Binding ShowBuildingList, Converter={StaticResource boolToVisConverter}}">
                    <StackPanel>
                        <TextBlock Style="{StaticResource CompactHeader}" Text="{l:Localize StatBuildings}" />
                        <ItemsControl ItemsSource="{Binding Buildings}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="0,2" Orientation="Horizontal">
                                        <TextBlock
                                            Width="28"
                                            FontWeight="SemiBold"
                                            Text="{Binding Count}" />
                                        <TextBlock
                                            Margin="4,0,6,0"
                                            Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                            Text="x" />
                                        <TextBlock Text="{Binding Name}" />
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ui:Card>

                <!--  Selected buildings list card  -->
                <ui:Card Style="{StaticResource CompactCardLargeStyle}" Visibility="{Binding ShowSelectedBuildingList, Converter={StaticResource boolToVisConverter}}">
                    <StackPanel>
                        <TextBlock Style="{StaticResource CompactHeader}" Text="{l:Localize StatBuildingsSelected}" />
                        <ItemsControl ItemsSource="{Binding SelectedBuildings}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="0,2" Orientation="Horizontal">
                                        <TextBlock
                                            Width="28"
                                            FontWeight="SemiBold"
                                            Text="{Binding Count}" />
                                        <TextBlock
                                            Margin="4,0,6,0"
                                            Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                            Text="x" />
                                        <TextBlock Text="{Binding Name}" />
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ui:Card>

            </WrapPanel>
        </Grid>
    </ScrollViewer>
</UserControl>
