<UserControl x:Class="AnnoDesigner.BuildingView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:l="clr-namespace:AnnoDesigner.Localization"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
             xmlns:converters="clr-namespace:AnnoDesigner.Converters"
             xmlns:coreConverters="clr-namespace:AnnoDesigner.Core.Converters;assembly=AnnoDesigner.Core"
             xmlns:coreModels="clr-namespace:AnnoDesigner.Core.Models;assembly=AnnoDesigner.Core"
             xmlns:my="clr-namespace:AnnoDesigner"
             xmlns:convertersLocal="clr-namespace:AnnoDesigner.Converters"
             xmlns:properties="clr-namespace:AnnoDesigner.Properties" >
    <UserControl.Resources>
        <coreConverters:UnsavedChangesConverter x:Key="converterUnsavedChanges"/>
        <coreConverters:BoolToVisibilityConverter
            x:Key="converterBoolToVisibility"
            FalseValue="Hidden"
            TrueValue="Visible"/>
        <coreConverters:BoolToVisibilityConverter
            x:Key="converterBoolToVisibilityCollapsed"
            FalseValue="Collapsed"
            TrueValue="Visible"/>
        <xctk:ColorToSolidColorBrushConverter x:Key="converterColorToSolidColorBrush"/>
        <HierarchicalDataTemplate DataType="{x:Type coreModels:AnnoObject}">
            <TextBlock Text="{Binding Label}"/>
        </HierarchicalDataTemplate>

        <Style x:Key="CardStyle"
               TargetType="Border">
            <Setter Property="Padding"
                    Value="0,16,0,16"/>
            <Setter Property="BorderThickness"
                    Value="0,0,0,1"/>
            <Setter Property="BorderBrush"
                    Value="{DynamicResource ExpanderHeaderBorderBrush}"/>
        </Style>

    </UserControl.Resources>
    <!-- Buildings panel extracted from MainWindow.xaml - bindings are unchanged and resolve against parent DataContext -->
    <DockPanel x:Name="BuildingsPanel"
               Grid.Row="2"
               LastChildFill="True">

        <Expander
            BorderBrush="{DynamicResource ExpanderHeaderBorderBrush}"
            DockPanel.Dock="Top"
            Header="{l:Localize BuildingSettings}"
            IsExpanded="True">
            <StackPanel>
                <DockPanel
                    Height="43"
                    VerticalAlignment="Center"
                    LastChildFill="False">
                    <Label VerticalAlignment="Center"
                           Content="{l:Localize Size}"/>
                    <ui:NumberBox
                        Width="58"
                        DockPanel.Dock="Right"
                        IsEnabled="True"
                        Minimum="1"
                        SpinButtonPlacementMode="Compact"
                        TabIndex="1"
                        Value="{Binding BuildingSettingsViewModel.BuildingHeight, FallbackValue=4}"/>
                    <Label
                        Margin="5,0,6,0"
                        VerticalAlignment="Center"
                        Content="x"
                        DockPanel.Dock="Right"/>
                    <ui:NumberBox
                        Width="60"
                        DockPanel.Dock="Right"
                        IsEnabled="True"
                        Minimum="1"
                        SpinButtonPlacementMode="Compact"
                        TabIndex="0"
                        Value="{Binding BuildingSettingsViewModel.BuildingWidth, FallbackValue=4}"/>
                </DockPanel>
                <!-- The rest of BuildingsPanel content is unchanged and copied below -->
                <DockPanel LastChildFill="False"
                           Visibility="Hidden">
                    <Label Content="{l:Localize Color}"/>

                    <xctk:ColorPicker
                        x:Name="colorPicker"
                        Width="140"
                        AdvancedTabHeader="{l:Localize Advanced}"
                        AvailableColorsHeader="{l:Localize AvailableColors}"
                        AvailableColorsSortingMode="HueSaturationBrightness"
                        DisplayColorAndName="True"
                        DisplayColorTooltip="True"
                        DockPanel.Dock="Right"
                        RecentColorsHeader="{l:Localize RecentColors}"
                        SelectedColor="{Binding BuildingSettingsViewModel.SelectedColor}"
                        ShowAvailableColors="True"
                        ShowDropDownButton="True"
                        ShowRecentColors="True"
                        StandardColorsHeader="{l:Localize StandardColors}"
                        StandardTabHeader="{l:Localize Standard}"
                        TabIndex="2"/>
                </DockPanel>
                <DockPanel LastChildFill="False"
                           Visibility="Hidden">

                    <!--  used when predefined colors are available  -->
                    <xctk:SplitButton
                        Width="48"
                        Command="{Binding BuildingSettingsViewModel.ApplyColorToSelectionCommand}"
                        DockPanel.Dock="Right"
                        ToolTip="{l:Localize ApplyColorToSelectionToolTip}">
                        <xctk:SplitButton.Resources>
                            <Style x:Key="stylePath"
                                   TargetType="{x:Type Path}">
                                <Style.Triggers>
                                    <Trigger Property="IsEnabled"
                                             Value="True">
                                        <Setter Property="Fill"
                                                Value="#FF000000"/>
                                    </Trigger>
                                    <Trigger Property="IsEnabled"
                                             Value="False">
                                        <Setter Property="Fill"
                                                Value="Gray"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </xctk:SplitButton.Resources>
                        <xctk:SplitButton.DropDownContent>
                            <Button
                                Command="{Binding BuildingSettingsViewModel.ApplyPredefinedColorToSelectionCommand}"
                                Content="{l:Localize ApplyPredefinedColorToSelection}"
                                ToolTip="{l:Localize ApplyPredefinedColorToSelectionToolTip}"/>
                        </xctk:SplitButton.DropDownContent>
                        <Grid
                            Width="24"
                            Height="24"
                            Visibility="Visible">
                            <Path
                                Width="16"
                                Height="16"
                                Margin="0,0,0,0"
                                Data="M10.237976,16.558633L15.362,21.68467C15.362,21.68467 15.362,32.671771 0,30.001748 3.9839783,29.020736 3.5959778,25.791718 5.9639893,20.122661 7.1269836,17.340638 10.237976,16.558633 10.237976,16.558633z M30.389984,0.00048406667C30.752991,0.0094867014 31.134979,0.14547426 31.494995,0.50648519 32.77597,1.7864956 31.215973,3.3455154 31.215973,3.3455152 31.215973,3.3455154 23.415985,11.147588 21.855988,12.708591 20.296997,14.270602 18.406982,18.619656 18.406982,18.619656L13.28299,13.495602C13.28299,13.495602 17.733978,11.707591 19.29599,10.147579 20.855988,8.5855531 28.655975,0.78248873 28.655975,0.78248861 28.655975,0.78248873 29.461975,-0.022526528 30.389984,0.00048406667z"
                                RenderTransformOrigin="0.5,0.5"
                                Stretch="Uniform"
                                Style="{StaticResource stylePath}">
                                <Path.RenderTransform>
                                    <TransformGroup>
                                        <RotateTransform Angle="0"/>
                                        <ScaleTransform ScaleX="1"
                                                        ScaleY="1"/>
                                    </TransformGroup>
                                </Path.RenderTransform>
                            </Path>
                        </Grid>
                    </xctk:SplitButton>
                </DockPanel>
                <DockPanel LastChildFill="True">
                    <DockPanel.Resources>
                        <Style x:Key="styleRectangle"
                               TargetType="{x:Type Rectangle}">
                            <Setter Property="Margin"
                                    Value="2"/>
                        </Style>
                    </DockPanel.Resources>
                    <Expander
                        MaxWidth="{Binding ActualWidth, ElementName=BuildingsPanel, Mode=OneWay}"
                        MaxHeight="90"
                        Header="{l:Localize ColorsInLayout}"
                        IsExpanded="False"
                        ToolTip="{l:Localize ColorsInLayoutToolTip}"
                        Visibility="{Binding BuildingSettingsViewModel.ShowColorsInLayout, Converter={StaticResource converterBoolToVisibility}}">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding BuildingSettingsViewModel.ColorsInLayout}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Rectangle
                                            Fill="{Binding MediaColor, Converter={StaticResource converterColorToSolidColorBrush}}"
                                            Stroke="#FFABADB3"
                                            StrokeThickness="1"
                                            Style="{StaticResource styleRectangle}"
                                            ToolTip="{Binding}">
                                            <Rectangle.InputBindings>
                                                <MouseBinding
                                                    Command="{Binding DataContext.BuildingSettingsViewModel.UseColorInLayoutCommand, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}, Mode=FindAncestor}}"
                                                    CommandParameter="{Binding}"
                                                    Gesture="LeftDoubleClick"/>
                                            </Rectangle.InputBindings>
                                        </Rectangle>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel
                                            Margin="0"
                                            HorizontalAlignment="Right"
                                            ItemHeight="20"
                                            ItemWidth="20"
                                            Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </ScrollViewer>
                    </Expander>
                </DockPanel>
                <DockPanel Margin="0,8,0,0"
                           LastChildFill="False">
                    <Label VerticalAlignment="Center"
                           Content="{l:Localize Label}"/>
                    <TextBox
                        Width="140"
                        DockPanel.Dock="Right"
                        IsEnabled="True"
                        TabIndex="4"
                        Text="{Binding BuildingSettingsViewModel.BuildingName}"/>
                    <TextBox
                        Width="140"
                        Height="10"
                        DockPanel.Dock="Right"
                        IsEnabled="False"
                        Text="{Binding BuildingSettingsViewModel.BuildingIdentifier}"
                        Visibility="Collapsed"/>
                    <TextBox
                        Width="140"
                        Height="10"
                        DockPanel.Dock="Right"
                        IsEnabled="False"
                        Text="{Binding BuildingSettingsViewModel.BuildingRealName}"
                        Visibility="Collapsed"/>
                </DockPanel>
                <DockPanel Height="46"
                           LastChildFill="False">
                    <Label VerticalAlignment="Center"
                           Content="{l:Localize Icon}"/>
                    <ComboBox
                        x:Name="comboBoxIcon"
                        Width="140"
                        Height="46"
                        DockPanel.Dock="Right"
                        IsEnabled="True"
                        ItemsSource="{Binding AvailableIcons}"
                        ScrollViewer.CanContentScroll="True"
                        SelectedItem="{Binding SelectedIcon}"
                        TabIndex="6"
                        TextSearch.TextPath="DisplayName">
                        <ComboBox.Resources>
                            <Style TargetType="{x:Type Popup}">
                                <!--<Setter Property="MinWidth"
                                    Value="140" />
                            <Setter Property="MaxWidth"
                                    Value="340" />-->
                                <Setter Property="Width"
                                        Value="300"/>
                            </Style>
                            <converters:IconImageToDisplayNameConverter x:Key="converterIconImageToDisplayName"/>
                        </ComboBox.Resources>
                        <ComboBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel VirtualizingPanel.IsVirtualizing="True"
                                                        VirtualizingPanel.VirtualizationMode="Recycling"/>
                            </ItemsPanelTemplate>
                        </ComboBox.ItemsPanel>
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Viewbox Margin="5">
                                        <Image
                                            Width="23"
                                            Height="32"
                                            Source="{Binding Icon}"/>
                                    </Viewbox>
                                    <TextBlock
                                        Margin="0,5,5,5"
                                        VerticalAlignment="Center"
                                        Text="{Binding ., Converter={StaticResource converterIconImageToDisplayName}}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </DockPanel>
                <DockPanel Margin="0,8,0,0"
                           LastChildFill="False">
                    <Label VerticalAlignment="Center"
                           Content="{l:Localize InfluenceType}"/>
                    <ComboBox
                        Width="140"
                        DisplayMemberPath="Name"
                        DockPanel.Dock="Right"
                        IsEnabled="True"
                        ItemsSource="{Binding BuildingSettingsViewModel.BuildingInfluences}"
                        SelectedItem="{Binding BuildingSettingsViewModel.SelectedBuildingInfluence}"
                        TabIndex="6"/>
                </DockPanel>
                <DockPanel
                    Margin="0,6,0,0"
                    LastChildFill="False"
                    Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRadiusVisible, Converter={StaticResource converterBoolToVisibilityCollapsed}}">
                    <Label VerticalAlignment="Center"
                           Content="{l:Localize Radius}"/>
                    <ui:NumberBox
                        Width="140"
                        DockPanel.Dock="Right"
                        IsEnabled="True"
                        Minimum="0"
                        SpinButtonPlacementMode="Compact"
                        TabIndex="8"
                        Value="{Binding BuildingSettingsViewModel.BuildingRadius, FallbackValue=1}"/>
                </DockPanel>
                <DockPanel
                    Margin="0,5,0,0"
                    LastChildFill="False"
                    Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRangeVisible, Converter={StaticResource converterBoolToVisibilityCollapsed}}">
                    <Label VerticalAlignment="Center"
                           Content="{l:Localize Distance}"/>
                    <ui:NumberBox
                        Width="140"
                        DockPanel.Dock="Right"
                        IsEnabled="True"
                        Minimum="0"
                        SpinButtonPlacementMode="Compact"
                        TabIndex="9"
                        Value="{Binding BuildingSettingsViewModel.BuildingInfluenceRange, FallbackValue=1}"/>
                </DockPanel>
                <DockPanel
                    Margin="0,4,0,0"
                    LastChildFill="False"
                    Visibility="{Binding BuildingSettingsViewModel.IsBuildingInfluenceInputRangeVisible, Converter={StaticResource converterBoolToVisibilityCollapsed}}">
                    <CheckBox
                        Margin="0,3,0,5"
                        Content="{l:Localize PavedStreet}"
                        DockPanel.Dock="Right"
                        IsChecked="{Binding BuildingSettingsViewModel.IsPavedStreet}"
                        IsThreeState="False"
                        ToolTip="{l:Localize PavedStreetToolTip}">
                        <CheckBox.Style>
                            <Style TargetType="{x:Type CheckBox}">
                                <Setter Property="Background"
                                        Value="{DynamicResource SystemFillColorSuccessBrush}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding BuildingSettingsViewModel.IsPavedStreet}"
                                                 Value="True">
                                        <Setter Property="Background"
                                                Value="{DynamicResource SystemFillColorCriticalBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </CheckBox.Style>
                    </CheckBox>
                </DockPanel>
                <DockPanel LastChildFill="False">
                    <Label Content="{l:Localize Options}"/>
                    <StackPanel DockPanel.Dock="Right"
                                Orientation="Vertical">
                        <CheckBox
                            Margin="0,5,0,5"
                            VerticalAlignment="Center"
                            Content="{l:Localize EnableLabel}"
                            IsChecked="{Binding BuildingSettingsViewModel.IsEnableLabelChecked}"
                            IsThreeState="False"
                            TabIndex="9"/>
                        <CheckBox
                            Margin="0,0,0,5"
                            VerticalAlignment="Center"
                            Content="{l:Localize Borderless}"
                            IsChecked="{Binding BuildingSettingsViewModel.IsBorderlessChecked}"
                            IsThreeState="False"
                            TabIndex="10"/>
                        <CheckBox
                            Margin="0,0,0,5"
                            VerticalAlignment="Center"
                            Content="{l:Localize Road}"
                            IsChecked="{Binding BuildingSettingsViewModel.IsRoadChecked}"
                            IsThreeState="False"
                            TabIndex="11"/>
                    </StackPanel>
                </DockPanel>
                <Button
                    Height="Auto"
                    Command="{Binding PlaceBuildingCommand}"
                    Content="{l:Localize PlaceBuilding}"
                    TabIndex="12"/>
            </StackPanel>
        </Expander>
    </DockPanel>

</UserControl>
